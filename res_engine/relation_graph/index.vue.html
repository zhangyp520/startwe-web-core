<template>
    <div>
        <div class="rg-header">
            <div>
                <img src="/image/left-jt.png" class="header-jt" /> {{projectName}}
            </div>
            <div>
                <el-button type="primary" @click="saveChange" size="small">保 存</el-button>
                <el-button @click="cancelChange" size="small">刷 新</el-button>
            </div>
        </div>
        <div id="drawDiv" :style="containerHeight">
            <div class="left-content" @mouseup="mouseUp">
                <div class="left-content-parent" ref="leftContent">
                    <el-input
                        placeholder="输入关键字进行过滤"
                        v-model="filterText" size="mini" >
                    </el-input>
                    <el-tree
                            style="margin-top: 14px; overflow-y: auto"
                            class="filter-tree"
                            :data="modelData"
                            default-expand-all
                            :filter-node-method="filterNode"
                            node-key="id"
                            :props="defaultProps"
                            ref="tree">
                            <span :class="setCustomClass(node, data)" slot-scope="{ node, data }" :id="data.id">
                            <span>{{ data.name }}</span>
                            </span>
                    </el-tree>
                    <div v-show="isDragging" class="show-div" ref="controlNode">{{showName}}</div>
                </div>
            </div>
            <div class="point-parent" id="points-parent" @mousedown="mouseDown" @mousemove="mouseMove" @mouseup="mouseUp">
                <div class="panel-body points demo flow_chart" id="points" :style="calZoom" style="top: 0;left: 0;"
                    ref="canvas">
                    <div v-for="(val, point) in data.formMap" :id="point" class="point" :style="calPosition(point, val)">
                        <div :id="`drag-${point}`"
                            style="padding:0 0.5em; background: #409EFF; cursor: default; display: flex; justify-content: space-between">
                            <span class="name-change" style="font-size: 12px;">{{val.name}}</span></div>
                        <div class="add-content">
                            <div v-for="(val1, m) in val.fieldMap" title="拖动可以进行连线"
                                style="color:black; border-top: 1px solid #cccccc;display: flex;padding: 0 0.8em; justify-content: space-between"
                                :id="`${point}-${m}`">
                                <div class="param-name" style="font-size: 12px">{{val1.name}}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <el-dialog
                    title="关联设置"
                    :visible.sync="editVisible"
                    size="mini"
                    label-position="top"
                    width="30%">
                <el-form v-if="tableForm" size="mini" ref="tableForm" :model="tableForm" label-width="100">
                    <el-form-item prop="name" label="子表名：">
                        <el-input v-model="data.formMap[tableForm.formId].name" readonly/>
                    </el-form-item>
                    <el-form-item label="子表关联字段">
                        <el-input v-model="data.formMap[tableForm.formId].fieldMap[tableForm.fieldId].name" readonly/>
                    </el-form-item>
                    <el-form-item label="父表名：">
                        <el-input v-model="data.formMap[tableForm.targetFormId].name" readonly/>
                    </el-form-item>
                    <el-form-item label="父表关联字段：">
                        <el-input v-model="data.formMap[tableForm.targetFormId].fieldMap[tableForm.targetFieldId].name"
                                readonly/>
                    </el-form-item>
                    <el-form-item label="父表关联显示字段：">
                        <el-select style="width: 100%" v-model="tableForm.targetDisplayFieldId" @change="changeSelect">
                            <el-option v-for="(val, key) in data.formMap[tableForm.targetFormId].fieldMap" :key="key"
                                    :value="val.id" :label="val.name"></el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="连线类型：">
                        <el-select style="width: 100%" v-model="tableForm.lineType" :disabled="optionChoose" @change="changeRelation">
                            <el-option key="1" :value="1" label="关联">关联</el-option>
                            <el-option key="2" :value="2" label="推送">推送</el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="对应关系：">
                        <el-radio-group v-model="tableForm.cardinality">
                            <el-radio :disabled="tableForm.lineType == 2" label="many2one">多对一</el-radio>
                            <el-radio :disabled ="tableForm.lineType == 2" label="one2one">一对一</el-radio>
                            <el-radio :disabled ="tableForm.lineType == 1" :label="null">无</el-radio>
                        </el-radio-group>
                    </el-form-item>
                </el-form>
                <div slot="footer" class="dialog-footer">
                    <el-button size="mini" @click="editCancel">取 消</el-button>
                    <el-button size="mini" type="danger" @click="deleteConnection">删 除</el-button>
                    <el-button size="mini" type="primary" @click="tableChange">确 定</el-button>
                </div>
            </el-dialog>
        </div>
    </div>
</template>

<script>
    exports = {
        templateType: 'vue',
        data: function () {
            return {
                projectName:"",
                containerHeight:"",
                optionChoose: false,
                jsPlumbReady: false,
                filterText: '',
                paramCfg: null,
                lineAttr: {},
                overlay: null,
                newElements: null,
                newNodeEvent: null,
                isDragging: false,
                instance: {},
                isMoving: false,
                zoom: 1,
                currentPosition: {x: 0, y: 0},
                lastPosition: {x: 0, y: 0},
                lastMove: {x: 0, y: 0},
                showName: '',
                tableForm: null,
                currentItem: 0,
                currentConn: null,
                editVisible: false,
                dialogVisible: false,
                // 左侧菜单
                modelData: [],
                defaultProps: {
                    children: 'children',
                    label: 'name'
                },
                // 假数据
                data: {}
            }
        },
        watch: {
            'data.formId'(val) {
                let elList = document.querySelectorAll('.left-sub-title')
                elList.forEach(el => {
                    if (val.indexOf(el.id) > -1) {
                        el.className = 'no-draggable'
                    }
                })
            },
            filterText(val) {
                this.$refs.tree.filter(val);
            },
            jsPlumbReady(val) {
                if (val && this.data !== {}) {
                    this.createFlow(this.data);
                }
            },
            editVisible(val) {
                if (val) {
                    let vm = this;
                    let connectionList = vm.instance.getAllConnections();
                    let repeat = false;
                    connectionList.map(function (item) {
                        if (item.sourceId === vm.currentConn.sourceId && item.getOverlay('label').label === '关联' && vm.currentConn.getOverlay('label').label === '推送') {
                            repeat = true;
                            return;
                        }
                        if (item.targetId === vm.currentConn.targetId && item.getOverlay('label').label === '推送' && vm.currentConn.getOverlay('label').label === '关联') {
                            repeat = true;
                            return;
                        }
                    });
                    this.optionChoose = repeat
                }
            }
        },
        mounted: function () {
            this.containerHeight = `height:${document.documentElement.clientHeight - 64}px; display: flex; justify-content: flex-end`;
            let that = this;
            window.onresize = function () {
                that.containerHeight = `height:${document.documentElement.clientHeight - 64}px; display: flex; justify-content: flex-end`;
            }

            let param = this.$router.query;
            let paramCfg = {};
            var me = this;
            if (param.ouiInWindowDialog && ((param.ouiInWindowDialog + '') == 'true')) {//openWindow
                var windowId = param.windowId;
                if ((!window.opener) || (!window.opener._openMap) || (!window.opener._openMap[windowId])) {
                    //父窗体不存在，则关闭当前窗体
                    oui.getTop().oui.alert('调用页面设计器入口页面已经刷新或者关闭，请尝试关闭当前页面后，重新打开');
                    //window.close();
                    return;
                }
                if (window.opener._openMap[windowId].params) {
                    paramCfg = oui.parseJson(window.opener._openMap[windowId].params);
                }
                paramCfg.viewType = 'openWindow';
            } else if (param.ouiInDialog && ((param.ouiInDialog + '') == 'true')) {//urlDialog
                var dialog = oui.getCurrUrlDialog();
                paramCfg = oui.parseJson(dialog.attr('params'));
                paramCfg.viewType = 'urlDialog';
            }
            this.paramCfg = paramCfg;
            if (this.paramCfg.modules) {
                this.modelData = this.paramCfg.modules;
            }
            if (param.moduleId) {
                this.ajax4loadRelations(param.moduleId, function () {
                    jsPlumb.ready(() => {
                        me.jsPlumbReady = true;
                    });
                });
            }

            document.onmousewheel = (e) => {
                if (e.target.id === 'points-parent' || e.target.id === 'points') {
                    this.setZoom(e);
                }
            }
        },
        computed: {
            calZoom(e) {
                if (e > 0) {
                    this.zoom += 0.1
                } else if (e < 0) {
                    this.zoom -= 0.1
                }
                let z = {
                    "-webkit-transform": `scale(${this.zoom.toFixed(1)})`,
                    "-moz-transform": `scale(${this.zoom.toFixed(1)})`,
                    "-ms-transform": `scale(${this.zoom.toFixed(1)})`,
                    "-o-transform": `scale(${this.zoom.toFixed(1)})`,
                    "transform": `scale(${this.zoom.toFixed(1)})`
                };
                console.log(this.zoom);
                return z;
            },
        },
        methods: {
            /* 获取字段列表**/
            ajax4getFields: function (moduleId, formId, success, error) {
                var url = this.paramCfg.queryPageFieldsInProjectUrl;
                url = oui.setParam(url, 'moduleId', moduleId); //模块id处理
                oui.postData(url, {
                    formId: formId  //表单id处理
                }, function (res) {
                    success && success(res);
                }, function (res) {
                    error && error(res);
                }, '加载中...');
            },
            /* 加载整体业务关系,调用时传入当前模块ID进行加载 */
            ajax4loadRelations: function (moduleId, success, error) {
                let vm = this;
                var url = this.paramCfg.loadRelationsUrl;
                url = oui.setParam(url, 'moduleId', moduleId); //模块id处理
                oui.postData(url, {}, function (res) {
                    vm.projectName = res.project.name;
                    vm.data = res;
                    if (vm.jsPlumbReady) {
                        vm.createFlow(vm.data);
                    }
                    success && success(res);
                }, function (res) {
                    error && error(res);
                }, '加载中...');
            },
            /**保存整体业务关系,调用时传入当前模块id
             * */
            ajax4saveRelations: function (moduleId, relations, success, error) {
                var url = this.paramCfg.saveRelationsUrl;
                url = oui.setParam(url, 'moduleId', moduleId); //模块id处理
                oui.postData(url, {
                    relations: relations
                }, function (res) {
                    success && success(res);
                }, function (res) {
                    error && error(res);
                }, '加载中...');
            },
            /**调用时传入当前模块ID (非选择表单所属模块ID) */
            ajax4saveFormFieldRelations: function (moduleId, formId, fieldId, otherAttrs, success, error) {
                var url = this.paramCfg.saveFormFieldRelationsUrl;
                url = oui.setParam(url, 'moduleId', moduleId); //模块id处理
                oui.postData(url, {
                    formId: formId,
                    fieldId: fieldId,
                    otherAttrs: otherAttrs
                }, function (res) {
                    success && success(res);
                }, function (res) {
                    error && error(res);
                }, '加载中...');

            },
            changeRelation(val) {
                if (val === 2) {
                    this.$set(this.tableForm, 'cardinality', null)
                } else {
                    this.$set(this.tableForm, 'cardinality', 'many2one')
                }
            },
            setCustomClass(node, data) {
                let basic = ''
                if (data.id === this.paramCfg.currModuleId) {
                    return basic + node.childNodes.length === 0 ? 'left-sub-title special' : 'special'
                }
                return node.childNodes.length === 0 ? 'left-sub-title' : null
            },
            filterNode(value, data) {
                if (!value) return true;
                return data.name.indexOf(value) !== -1;
            },
            mouseUp(e) {
                if (this.isMoving) {
                    this.lastPosition = {x: this.$refs.canvas.style.left, y: this.$refs.canvas.style.top}
                    this.$refs.canvas.style.cursor = 'default';
                    this.isMoving = false;
                }
            },
            mouseDown(e) {
                this.isMoving = true
                this.currentPosition.x = e.x;
                this.currentPosition.y = e.y;
                this.lastMove.x = e.x;
                this.lastMove.y = e.y;
            },
            mouseMove(e) {
                if (this.isMoving) {
                    this.$refs.canvas.style.cursor = 'grabbing';
                    this.$refs.canvas.style.left = parseInt(this.lastPosition.x) + e.x - this.currentPosition.x + 'px';
                    this.$refs.canvas.style.top = parseInt(this.lastPosition.y) + e.y - this.currentPosition.y + 'px';
                    if (parseInt(this.$refs.canvas.style.left) < 0 - (this.$refs.canvas.getBoundingClientRect().width - this.$refs.canvas.offsetWidth) / 2) {
                        this.$refs.canvas.style.left = (this.$refs.canvas.offsetWidth - this.$refs.canvas.getBoundingClientRect().width) / 2 + 'px';
                    }
                    if (parseInt(this.$refs.canvas.style.left) > (this.$refs.canvas.getBoundingClientRect().width - this.$refs.canvas.offsetWidth) / 2) {
                        this.$refs.canvas.style.left = (this.$refs.canvas.getBoundingClientRect().width - this.$refs.canvas.offsetWidth) / 2 + 'px';
                    }
                    if (parseInt(this.$refs.canvas.style.top) < 0 - (this.$refs.canvas.getBoundingClientRect().height - this.$refs.canvas.offsetHeight) / 2) {
                        this.$refs.canvas.style.top = (this.$refs.canvas.offsetHeight - this.$refs.canvas.getBoundingClientRect().height) / 2 + 'px';
                    }
                    if (parseInt(this.$refs.canvas.style.top) > (this.$refs.canvas.getBoundingClientRect().height - this.$refs.canvas.offsetHeight) / 2) {
                        this.$refs.canvas.style.top = (this.$refs.canvas.getBoundingClientRect().height - this.$refs.canvas.offsetHeight) / 2 + 'px';
                    }
                }
            },
            setZoom(e) {
                if (e.deltaY < 0 && this.zoom < 2) {
                    this.zoom = this.zoom + 0.1
                } else if (e.deltaY > 0 && this.zoom > 1) {
                    this.$refs.canvas.style.left = '0px';
                    this.$refs.canvas.style.top = '0px';
                    this.lastPosition = {x: 0, y: 0};
                    this.zoom = this.zoom - 0.1
                } else {
                    return;
                }
            },
            cancelChange() {
                location.reload();
            },
            // 没有坐标生成1000 X 500 的随机坐标
            calPosition(point, val) {
                if (val.x !== undefined && val.y !== undefined) {
                    return {left: val.x + '%', top: val.y + '%'}
                } else {
                    let randomX = Math.ceil(Math.random() * 70);
                    let randomY = Math.ceil(Math.random() * 70);
                    this.data.formMap[point].x = randomX;
                    this.data.formMap[point].y = randomY;
                    return {left: randomX + '%', top: randomY + '%'}
                }
            },
            changeSelect(e) {
                console.log(this.tableForm.targetDisplayFieldId);
                console.log(this.data.formMap[this.tableForm.targetFormId].fieldMap);
            },
            editCancel() {
                this.editVisible = false;
                this.tableForm = null;
            },
            tableChange() {
                // 保存修改后连线
                this.editVisible = false;
                this.currentConn.getOverlay("label").setLabel(this.tableForm.lineType === 1 ? '关联' : '推送');
                if (this.tableForm.cardinality === 'many2one') {
                    this.currentConn.getOverlay("labelF").setLabel('N')
                    this.currentConn.getOverlay("labelE").setLabel('1')
                } else if (this.tableForm.cardinality === 'one2one') {
                    this.currentConn.getOverlay("labelF").setLabel('1')
                    this.currentConn.getOverlay("labelE").setLabel('1')
                } else {
                    this.currentConn.getOverlay("labelF").setLabel('')
                    this.currentConn.getOverlay("labelE").setLabel('')
                }
                this.currentConn.setPaintStyle({
                    strokeWidth: 1,
                    stroke: this.tableForm.lineType === 2 ? "#67C23A" : '#409EFF'
                });
                this.currentConn.setHoverPaintStyle({
                    strokeWidth: 3,
                    stroke: this.tableForm.lineType === 2 ? "#85ce61" : '#66b1ff'
                });
                this.tableForm.lineId = (this.tableForm.formId + '_' + this.tableForm.fieldId + '_' + this.tableForm.targetFormId + '_' + this.tableForm.targetFieldId + '_' + this.tableForm.lineType);
                let vm = this;
                let index = 0
                vm.data.formMap[this.tableForm.formId].fieldMap[this.tableForm.fieldId].otherAttrs.targetLines.forEach(item => {
                    if (item.lineType === 1) {
                        index++
                    }
                })
                if (index > 0) {
                    vm.data.formMap[this.tableForm.formId].fieldMap[this.tableForm.fieldId].otherAttrs.useRelation = true
                } else {
                    vm.data.formMap[this.tableForm.formId].fieldMap[this.tableForm.fieldId].otherAttrs.useRelation = false
                }
                vm.ajax4saveFormFieldRelations(vm.$router.query.moduleId, this.tableForm.formId, this.tableForm.fieldId, vm.data.formMap[this.tableForm.formId].fieldMap[this.tableForm.fieldId].otherAttrs, function (response) {
                    vm.$message({
                        message: '连接成功',
                        type: 'success'
                    });
                }, function (error) {
                    vm.$message({
                        message: error,
                        type: 'error'
                    });
                });
            },
            cancel() {
                this.dialogVisible = false;
            },
            // 增加字段项
            editTable(conn) {
                let vm = this;
                vm.editVisible = true;
                vm.currentConn = conn;
                vm.data.formMap[conn.sourceId.split('-')[0]].fieldMap[conn.sourceId.split('-')[1]].otherAttrs.targetLines.forEach(element => {
                    if (element.targetFormId == conn.targetId.split('-')[0] && element.targetFieldId == conn.targetId.split('-')[1]) {
                        vm.currentItem = vm.data.formMap[conn.sourceId.split('-')[0]].fieldMap[conn.sourceId.split('-')[1]].otherAttrs.targetLines.indexOf(element);
                        vm.tableForm = element
                    }
                })
            },
            deleteConnection() {
                let vm = this;
                vm.editVisible = false;
                vm.instance.deleteConnection(vm.currentConn);
                if (vm.data.formMap[vm.currentConn.sourceId.split('-')[0]].fieldMap[vm.currentConn.sourceId.split('-')[1]].otherAttrs.targetLines.splice(vm.currentItem, 1)) {
                    let index = 0;
                    vm.data.formMap[vm.currentConn.sourceId.split('-')[0]].fieldMap[vm.currentConn.sourceId.split('-')[1]].otherAttrs.targetLines.forEach(item => {
                        if (item.lineType === 1) {
                            index++;
                        }
                    })
                    if (index > 0) {
                        vm.data.formMap[vm.currentConn.sourceId.split('-')[0]].fieldMap[vm.currentConn.sourceId.split('-')[1]].otherAttrs.useRelation = true;
                    } else {
                        vm.data.formMap[vm.currentConn.sourceId.split('-')[0]].fieldMap[vm.currentConn.sourceId.split('-')[1]].otherAttrs.useRelation = false;
                    }
                    vm.data.lineIds.splice(vm.data.lineIds.indexOf(vm.currentItem.lineId), 1)
                    vm.ajax4saveFormFieldRelations(vm.$router.query.moduleId, vm.currentConn.sourceId.split('-')[0], vm.currentConn.sourceId.split('-')[1], vm.data.formMap[vm.currentConn.sourceId.split('-')[0]].fieldMap[vm.currentConn.sourceId.split('-')[1]].otherAttrs, function (response) {
                        vm.$message({
                            message: '删除成功',
                            type: 'success'
                        });
                    }, function (error) {
                        vm.$message({
                            message: error,
                            type: 'error'
                        });
                    });
                } else {
                    this.$message({
                        message: '删除错误',
                        type: 'error'
                    });
                }

            },
            saveChange() {
                let vm = this;
                this.ajax4saveRelations(vm.$router.query.moduleId, this.data, function (response) {
                    vm.$message({
                        message: '保存成功',
                        type: 'success'
                    });
                }, function (error) {
                    vm.$message({
                        message: error,
                        type: 'error'
                    });
                });
            },
            createFlow() {
                let vm = this;
                const color = '#409EFF';
                window.s = vm.instance = jsPlumb.getInstance({
                    // notice the 'curviness' argument to this Bezier curve.
                    // the curves on this page are far smoother
                    // than the curves on the first demo, which use the default curviness value.
                    // Connector: ["Straight"],
                    Connector: ['Flowchart', {curviness: 50}],
                    DragOptions: {cursor: 'pointer', zIndex: 5000},
                    PaintStyle: {lineWidth: 5, stroke: color},
                    HoverPaintStyle: {stroke: '#66b1ff', lineWidth: 20},
                    deleteEndpointsOnDetach: false,
                    Container: 'points',
                    Endpoint: ['Blank', {radius: 12}],
                    EndpointStyle: {
                        stroke: "#aaa",
                        fill: "#F2F2F2",
                        radius: 3,
                        strokeWidth: 1
                    },
                    ConnectionOverlays: [  //连线的叠加组件，如箭头、标签
                        ["Arrow", {  //箭头参数设置
                            location: 1,
                            visible: true,
                            width: 11,
                            length: 11,
                            id: "ARROW"
                        }], [
                            "Label",
                            {
                                location: 0.5,
                                label: '关联',
                                visible: true,
                                id: "label",
                                cssClass: "aLabel"
                            }],
                            ["Label",
                            {
                                location: 0.2,
                                label: '',
                                visible: true,
                                id: "labelF",
                                cssClass: "sLabel"
                            }], [
                            "Label",
                            {
                                location: 0.8,
                                label: '',
                                visible: true,
                                id: "labelE",
                                cssClass: "sLabel"
                            }]
                    ]
                });
                setTimeout(() => {
                    vm.instance.draggable(document.querySelectorAll('.point'), {
                        containment: 'points',
                        // 拖拽后改变位置
                        stop: function (e) {
                            vm.data.formMap[e.el.id].x = (e.pos[0] / e.el.parentNode.offsetWidth).toFixed(2) * 100;
                            vm.data.formMap[e.el.id].y = (e.pos[1] / e.el.parentNode.offsetHeight).toFixed(2) * 100;
                        }
                    });
                    vm.instance.draggable(document.querySelectorAll('.left-sub-title'), {
                        helper: 'clone',
                        scope: 'ss',
                        drag: function (e) {
                            if (e.el.className.indexOf('left-sub-title') > -1) {
                                vm.isDragging = true;
                                vm.showName = e.el.textContent;
                                vm.$refs.controlNode.id = e.el.id
                                vm.$refs.controlNode.style.left = e.pos[0] + 6 + 'px';
                                vm.$refs.controlNode.style.top = e.pos[1] + 54 + 'px';
                            }
                        },
                        stop: function () {
                            vm.isDragging = false;
                        }
                    });
                    // 拖拽新增
                    vm.instance.droppable('points', {
                        scope: 'ss',
                        drop: function (event) {
                            if (vm.isDragging) {
                                let leftP = ((event.e.x - vm.$refs.leftContent.offsetWidth) / event.drop.el.offsetWidth).toFixed(2) * 100;
                                let topP = (event.e.y / event.drop.el.offsetHeight).toFixed(2) * 100;
                                vm.ajax4getFields(vm.$router.query.moduleId, event.drag.el.id, function (response) {
                                    // 数组转换成map
                                    let map = {};
                                    response.fields.forEach(row => {
                                        map[row.id] = row
                                    })
                                    vm.$set(vm.data.formMap, event.drag.el.id, {
                                        x: leftP,
                                        y: topP,
                                        name: event.drag.el.textContent,
                                        fieldIds: [1, 2],//字段id列表
                                        fieldMap: map
                                    });
                                    vm.data.formId.push(event.drag.el.id)
                                    vm.isDragging = false;
                                    vm.showName = '';
                                    vm.$nextTick(() => {
                                        vm.addNew();
                                    });
                                })
                            }
                        }
                    });
                    vm.setjsPlumbAttr();
                }, 100)

            },
            addNew() {
                var vm = this;
                // 为新的表添加事件
                let lastIndex = Object.keys(vm.data.formMap).length - 1
                let lastNode = vm.data.formMap[Object.keys(vm.data.formMap)[lastIndex]];
                vm.instance.draggable(document.querySelectorAll('.point')[lastIndex], {
                    containment: 'points',
                    // 拖拽后改变位置
                    stop: function (e) {
                        vm.data.formMap[e.el.id].x = (e.pos[0] / e.el.parentNode.offsetWidth).toFixed(2) * 100;
                        vm.data.formMap[e.el.id].y = (e.pos[1] / e.el.parentNode.offsetHeight).toFixed(2) * 100;
                    }
                });
                vm.instance.batch(() => {
                    for (const m in lastNode.fieldMap) {
                        vm.instance.makeSource(Object.keys(vm.data.formMap)[lastIndex] + '-' + m, {
                            anchor: ["Continuous", {faces: ["left", "right"]}],
                            endpoint: 'Dot',
                        });
                        vm.instance.makeTarget(Object.keys(vm.data.formMap)[lastIndex] + '-' + m, {
                            anchor: ["Continuous", {faces: ["left", "right"]}],
                            allowLoopback: false
                        });
                    }
                })
            },
            setjsPlumbAttr() {
                let vm = this;
                // suspend drawing and initialise.
                vm.instance.batch(() => {
                    // init point
                    for (const point in vm.data.formMap) {
                        for (const m in vm.data.formMap[point].fieldMap) {
                            vm.instance.makeSource(point + '-' + m, {
                                anchor: ["Continuous", {faces: ["left", "right"]}],
                                endpoint: 'Dot',
                            });
                            vm.instance.makeTarget(point + '-' + m, {
                                anchor: ["Continuous", {faces: ["left", "right"]}],
                                allowLoopback: false
                            });
                        }
                    }
                    // init transition
                    for (const i in vm.data.formMap) {
                        // 有关系表
                        for (const p in vm.data.formMap[i].fieldMap) {
                            let targetLines = vm.data.formMap[i].fieldMap[p].otherAttrs.targetLines;
                            if (targetLines && targetLines.length > 0) {
                                for (const line in targetLines) {
                                    let me = vm.instance.connect({
                                        source: targetLines[line].formId + '-' + targetLines[line].fieldId,
                                        target: targetLines[line].targetFormId + '-' + targetLines[line].targetFieldId,
                                        paintStyle: {
                                            strokeWidth: 1,
                                            stroke: targetLines[line].lineType === 1 ? '#409EFF' : '#67C23A'
                                        },
                                        hoverPaintStyle: {
                                            stroke: targetLines[line].lineType === 1 ? '#66b1ff' : '#85ce61',
                                            strokeWidth: 3
                                        }
                                    })
                                    me.getOverlay('label').setLabel(targetLines[line].lineType === 1 ? '关联' : '推送');
                                    if (targetLines[line].cardinality && targetLines[line].cardinality === 'many2one') {
                                        me.getOverlay('labelF').setLabel('N')
                                        me.getOverlay('labelE').setLabel('1')
                                    } else if (targetLines[line].cardinality && targetLines[line].cardinality === 'one2one') {
                                        me.getOverlay('labelF').setLabel('1')
                                        me.getOverlay('labelE').setLabel('1')
                                    }
                                }
                            }
                        }
                    }
                    vm.instance.bind('click', function (conn, originalEvent) {
                        vm.editTable(conn);
                    });
                    vm.instance.bind('beforeDrop', function (conn) {
                        if (conn.sourceId.split('-')[0] === conn.targetId.split('-')[0]) {
                            vm.$message({
                                message: '同表字段不能相连 ！',
                                type: 'error'
                            });
                            return false;
                        }
                        if (conn.sourceId.split('-')[1] == 'id') {
                            vm.$message({
                                message: 'id 不能作为起点 ！',
                                type: 'error'
                            });
                            return false;
                        }
                        vm.lineAttr = {
                            lineId: (conn.sourceId + '_' + conn.targetId + '_1').replace(/-/g, '_'),
                            lineType: 1,
                            formId: conn.sourceId.split('-')[0],
                            fieldId: conn.sourceId.split('-')[1],
                            targetFormId: conn.targetId.split('-')[0],
                            targetFieldId: conn.targetId.split('-')[1],
                            targetDisplayFieldId: null,
                            cardinality: null
                        }
                        // 连线时判断是否已经有一根连线，每一个字段只能有一根关联类型的连线，其余均为推送
                        let lineTargetLength = vm.data.formMap[conn.sourceId.split('-')[0]].fieldMap[conn.sourceId.split('-')[1]].otherAttrs.targetLines && vm.data.formMap[conn.sourceId.split('-')[0]].fieldMap[conn.sourceId.split('-')[1]].otherAttrs.targetLines.length
                        if (!lineTargetLength || lineTargetLength < 1) {
                            // 该字段还没有连线时
                            vm.data.formMap[conn.sourceId.split('-')[0]].fieldMap[conn.sourceId.split('-')[1]].otherAttrs.targetLines = [];
                        } else {
                            // 有一条或多条时，需要判断
                            let lineTypeOneTime = 0;
                            let lineTypeTwoTime = 0;
                            vm.data.formMap[conn.sourceId.split('-')[0]].fieldMap[conn.sourceId.split('-')[1]].otherAttrs.targetLines.map(function (item) {
                                if (item.lineType === 1) {
                                    lineTypeOneTime++;
                                } else {
                                    lineTypeTwoTime++;
                                }
                            });
                            if (lineTypeOneTime > 0) {
                                // 出现至少一次的关联连线时， 下次的连线一定是推送
                                vm.lineAttr.lineType = 2;
                                vm.lineAttr.lineId = (conn.sourceId + '_' + conn.targetId + '_2').replace(/-/g, '_');
                            }
                        }
                        conn.connection.setPaintStyle({
                            strokeWidth: 1,
                            stroke: vm.lineAttr.lineType === 2 ? "#67C23A" : '#409EFF'
                        });
                        conn.connection.setHoverPaintStyle({
                            strokeWidth: 3,
                            stroke: vm.lineAttr.lineType === 2 ? "#85ce61" : '#66b1ff'
                        });
                        let repeat = true;
                        let connectionList = vm.instance.getAllConnections();
                        connectionList.map(function (item) {
                            if (item.targetId === conn.targetId && item.getOverlay("label").label === '推送' && conn.connection.getOverlay("label").label === '推送') {
                                repeat = false
                                vm.$message({
                                    message: '一个字段只可以被推送一次 ！',
                                    type: 'error'
                                });
                                return;
                            }
                            if (item.targetId === conn.sourceId && item.sourceId === conn.targetId) {
                                repeat = false
                                vm.$message({
                                    message: '两个字段之间不能相互连线 ！',
                                    type: 'error'
                                });
                                return;
                            }
                            if (item.targetId === conn.targetId && item.sourceId === conn.sourceId) {
                                repeat = false
                                vm.$message({
                                    message: '相同的两个字段只能有一种关系 ！',
                                    type: 'error'
                                });
                                return;
                            }
                        })
                        return repeat;
                    });
                    vm.instance.bind("connection", function (connInfo, originalEvent) {
                        connInfo.connection.getOverlay('label').setLabel(vm.lineAttr.lineType === 1 ? '关联' : '推送')
                        if (vm.lineAttr.lineType === 1) {
                            vm.lineAttr.cardinality = 'many2one'
                            connInfo.connection.getOverlay('labelF').setLabel('N')
                            connInfo.connection.getOverlay('labelE').setLabel('1')
                            vm.data.formMap[connInfo.connection.sourceId.split('-')[0]].fieldMap[connInfo.connection.sourceId.split('-')[1]].otherAttrs.useRelation = true;
                        }
                        vm.data.formMap[connInfo.connection.sourceId.split('-')[0]].fieldMap[connInfo.connection.sourceId.split('-')[1]].otherAttrs.targetLines.push(vm.lineAttr);
                        vm.data.lineIds.push(vm.lineAttr.lineId);
                        vm.ajax4saveFormFieldRelations(vm.$router.query.moduleId, connInfo.connection.sourceId.split('-')[0], connInfo.connection.sourceId.split('-')[1], vm.data.formMap[connInfo.connection.sourceId.split('-')[0]].fieldMap[connInfo.connection.sourceId.split('-')[1]].otherAttrs, function (response) {
                            vm.$message({
                                message: '连接成功',
                                type: 'success'
                            });
                        }, function (error) {
                            vm.$message({
                                message: error,
                                type: 'error'
                            });
                        });
                    });
                });
                vm.instance.fire('jsPlumbDemoLoaded', vm.instance);
            }
        }
    }
</script>
<style>
    /** DISABLE TEXT SELECTION (SET ON BODY WHEN DRAGGING IS OCCURRING) **/
    ._jsPlumb_drag_select * {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    /** FB **/
    #like {
        position: fixed;
        width: 77px;
        height: 70px;
        border: 0;
        right: 11px;
        bottom: -40px;
    }

    .el-tree-node__content {
        height: 36px;
    }

    #retweet_button {
        position: fixed;
        bottom: 30px;
        right: -7px;
    }

    body {
        padding: 0;
        margin: 0;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        background-color: #ccc;
    }

    #headerWrapper {
        width: 100%;
        background-color: white;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 100001;
        height: 44px;
        padding: 0;
        text-align: center;
        border-bottom: 1px solid #e5e5e5;
        box-shadow: 0px 1px #eee;
    }

    #header {
        margin-top: 0;

        height: 44px;
        font-size: 13px;
        margin-left: auto;
        margin-right: auto;

        line-height: 44px;
        max-width: 1000px;
        width: 80%;
    }

    @media screen and (max-width: 1000px) {
        #header {
            width: 100%;
        }
    }

    @media screen and (max-width: 800px) {
        #header select {
            display: none;
        }
    }

    @media screen and (max-width: 700px) {
        .library-links {
            right: 330px;
        }
    }

    @media screen and (max-width: 640px) {
        .logo {
            display: none;
        }

        #header {
            text-align: center;
            overflow: hidden;
        }
    }

    .explanation i {
        float: right;
        margin-right: 25px;
        margin-top: 13px;
        font-size: 25px;
        cursor: pointer;
    }

    .explanation i:hover {
        color: orange;
    }

    .words {
        text-align: left;
        padding: 50px;
        background-color: white;
    }

    .code {
        border: 1px solid #456;
    }

    .logo {
        font-size: 30px;
        color: #1f1f1f;
        text-shadow: 1px 1px #ccc;
        float: left;
        width: 154px;
        height: 44px;
        background-position: 0px 5px;
    }

    #main {
        margin-top: 106px;
        font-size: 80%;
        width: 80%;
        margin-left: auto;
        margin-right: auto;
        height: 600px;
        text-align: center;
        position: relative;
        max-width: 1200px;
        max-height: 1000px;
    }

    .demo {
        width: 100%;
        overflow: auto;
        height: 100%;
        position: absolute;
        background: #F5F5F5;
    }

    .explanation {
        text-align: center;
        opacity: 0.8;
        filter: alpha(opacity=80);
        width: 100%;
        z-index: 10000;
        overflow: hidden;
        font-size: 13px;
    }


    .commands {
        margin-bottom: 10px;
    }

    .commands:hover {
        z-index: 10000;
    }

    /* demo elements */

    a, a:visited {
        text-decoration: none;
        color: black;
        border-radius: 0.2em;
        -webkit-transition: color 0.15s ease-in;
        -moz-transition: color 0.15s ease-in;
        -o-transition: color 0.15s ease-in;
        transition: color 0.15s ease-in;
    }

    a:hover {
        color: #7AB02C;
    }

    a:active {
        color: #FF2300;
    }

    .menu, #render, #explanation {
        background-color: #fff;
    }

    .menu {
        float: right;
        font-size: 12px;
    }

    .menu a {
        margin-right: 19px;
    }

    .otherLibraries {
        display: inline;
    }

    #render a {
        margin-right: 10px;
    }

    .selected {
        color: orange !important;
    }

    .cmd {
        color: white;
        margin-right: 25px;
    }

    .cmd:hover {
        color: #FF2300;
        text-decoration: underline;
    }

    .cmd:active {
        color: #FF2300;
    }

    .label {
        font-size: 13px;
        padding: 8px;
        padding: 8px;
    }

    .component {
        border: 1px solid #346789;
        border-radius: 0.5em;
        opacity: 0.8;
        filter: alpha(opacity=80);
        background-color: white;
        color: black;
        padding: 0.5em;
        font-size: 0.8em;
    }

    .component:hover {
        border: 1px solid #123456;
        box-shadow: 2px 2px 19px #444;
        -o-box-shadow: 2px 2px 19px #444;
        -webkit-box-shadow: 2px 2px 19px #444;
        -moz-box-shadow: 2px 2px 19px #fff;
        opacity: 0.9;
        filter: alpha(opacity=90);
    }


    .demo-links, .library-links {
        position: fixed;
        right: 0;
        top: 44px;
        font-size: 11px;
        background-color: white;
        opacity: 0.8;
        padding-right: 10px;
        padding-left: 5px;
        text-transform: uppercase;
        z-index: 100001;
    }

    .demo-links div, .library-links a {
        display: inline;
        margin-right: 7px;
        margin-left: 7px;
    }

    .demo-links i, .library-links i {
        padding: 4px;
    }

    .library-links {
        right: 515px;
        height: 19px;
        line-height: 19px;
    }

    .current-library {
        color: #7AB02C !important;
    }

    /** Z-INDEX **/

    ._jsPlumb_connector {
        z-index: 18;
    }

    ._jsPlumb_endpoint {
        z-index: 19;
    }

    ._jsPlumb_overlay {
        z-index: 20;
    }

    .aLabel {
        background-color: white;
        padding: 0.4em;
        font: 12px sans-serif;
        color: #444;
        z-index: 21;
        border: 1px dotted gray;
        opacity: 0.8;
        filter: alpha(opacity=80);
        cursor: pointer;
    }

    .aLabel._jsPlumb_hover {
        background-color: #5C96BC;
        color: white;
        border: 1px solid white;
    }

    /* ---------------------- bootstrap dropdowns ------------------------- */
    .clearfix {
        *zoom: 1;
    }

    .clearfix:before,
    .clearfix:after {
        display: table;
        line-height: 0;
        content: "";
    }

    .clearfix:after {
        clear: both;
    }

    .hide-text {
        font: 0/0 a;
        color: transparent;
        text-shadow: none;
        background-color: transparent;
        border: 0;
    }

    .input-block-level {
        display: block;
        width: 100%;
        min-height: 30px;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
    }

    /* load test */


    #iframe {
        width: 98%;
        height: 1000px;
        position: absolute;
        top: 8px;
        left: 1%;
        border: 0;
    }

    #render {
        height: 20px;
    }

    #links {
        width: 143px;
        font-size: 14px;
        padding-left: 0px;
        position: fixed;
        left: 9px;
        top: 52px;
        z-index: 20;
        background-color: white;
    }

    ul {
        padding: 0;
    }

    li {
        list-style-type: none;
    }

    .current-tests {
        color: orange !important;
    }

    #qunit-tests li.pass, #qunit-tests li.fail {
        background-color: transparent;
    }

    .loadtest #main, #main.test {
        max-width: none;
        margin-top: 52px;
        background-color: white;

        margin-left: 162px;
    }


    .loadtest ._jsPlumb_connection {
        z-index: 3;
    }

    .loadtest .jspLoad {
        z-index: 4;
        position: absolute;
        width: 70px;
        height: 70px;
        cursor: pointer;
    }

    .loadtest #header {
        height: 11em;
        border: 2px solid #824563;
    }

    .special {
        color: #409EFF;
    }

    .loadtest #setup {
        float: left;
    }

    .loadtest #demo {
        margin-top: 10em;
        position: relative;
    }

    .loadtest #setup, .loadtest #output {
        font-size: 12px;
    }

    .workflow_image {
        /* for IE10+ touch devices */
        touch-action: none;
    }

    /** ELEMENTS **/
    .points .point {
        width: 12em;
        line-height: 2em;
    }

    .el-dialog__body {
        padding: 0px 20px !important;
    }

    .point-parent {
        position: relative;
        width: 86%;
        overflow: hidden;
        background: #e0e0e0;
    }

    .bottom-menu {
        justify-content: center;
        position: fixed;
        bottom: 0;
        width: 100%;
        border-top: 1px solid #eee;
        box-shadow: 2px 2px 19px #aaa;
        height: 40px;
        display: flex;
        align-items: center;
        padding: 6px 12px;
        z-index: 500;
    }

    .show-div {
        height: 40px;
        min-width: 180px;
        position: absolute;
        z-index: 1000;
    }

    .left-content-parent {
        position: relative;
        padding: 10px;
    }

    .left-sub-title {
        font-weight: normal;
        height: 40px;
        display: flex;
        align-items: center;
        z-index: 1000;
        cursor: pointer;
        font-size:14px;
    }

    .ivu-icon:before,
    .ivu-icon:after {
        font-family: Ionicons !important;
    }

    /** HOVER EFFECTS **/
    .points .point:hover, .points .point._jsPlumb_source_hover, .points .point._jsPlumb_target_hover {
        border: 1px solid #409EFF;
        color: white;
    }

    .jtk-endpoint-anchor {
    }

    .click-point {
        cursor: pointer;
    }

    .delete-show {
        cursor: pointer;
    }

    .point {
        background-color: white;
        border: 1px solid #409EFF;
        text-align: center;
        box-shadow: 2px 2px 19px #aaa;
        -o-box-shadow: 2px 2px 19px #aaa;
        -webkit-box-shadow: 2px 2px 19px #aaa;
        -moz-box-shadow: 2px 2px 19px #aaa;
        position: absolute;
        color: white;
        width: 80px;
        z-index: 900;
        -webkit-transition: -webkit-box-shadow 0.15s ease-in;
        -moz-transition: -moz-box-shadow 0.15s ease-in;
        -o-transition: -o-box-shadow 0.15s ease-in;
        transition: box-shadow 0.15s ease-in;
    }

    .left-content {
        width: 14%;
        border-right: #eee 1px solid;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-width: 180px;
        background: #FFFFFF;
        box-shadow: 2px 0px 6px 0px rgba(0, 21, 41, 0.12);
        position: relative;
        z-index: 99;
    }

    .param-name {
        text-align: left;
    }

    .no-draggable {
        color: #a0a0a0;
        cursor: not-allowed;
    }

    .point:hover {
        border: 1px solid #409EFF;
        box-shadow: 2px 2px 19px #444;
        -o-box-shadow: 2px 2px 19px #444;
        -webkit-box-shadow: 2px 2px 19px #444;
        -moz-box-shadow: 2px 2px 19px #fff;
        opacity: 0.9;
        filter: alpha(opacity=90);
    }

    path, ._jsPlumb_endpoint {
        cursor: pointer;
    }
    .sLabel{
        color: #444;
        font-size: 14px;
    }

    .rg-header{
        position: relative;
        z-index: 999;
        display: flex;
        justify-content: space-between;
        height: 64px;
        background: #FFFFFF;
        box-shadow: 0px 1px 4px 0px rgba(0, 21, 41, 0.12);
        padding:0px 26px;
    }

    .rg-header div{
        line-height:64px;
    }

    .rg-header .header-jt{
        vertical-align: middle;
        margin-top: -4px;
    }
</style>